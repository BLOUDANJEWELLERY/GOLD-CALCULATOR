<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gold Calculator | Bloudan Jewellery</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#011d57" />
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./service-worker-v7.js")
          .then(() => console.log("SW registered"))
          .catch((err) => console.error("SW registration failed:", err));
      });
    }
  </script>
  <link rel="apple-touch-icon" href="Icons/Icon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="icon" type="image/png" href="Icons/Icon.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overscroll-behavior: none;
    }

    body {
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      color: #1e293b;
      font-size: 14px;
      background: linear-gradient(
        to bottom,
        #fef3c7 0%,
        #f8fafc 25%,
        #fef3c7 50%,
        #f8fafc 75%,
        #fef3c7 100%
      );
      max-width: 800px;
      margin: 0 auto;
      height: 100vh;
      height: var(--vh, 100vh);
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, #fef3c7, #f8fafc);
      z-index: -1;
      pointer-events: none;
    }

    .header, footer {
      position: relative;
      z-index: 10;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 12px;
      background: transparent;
      position: relative;
      z-index: 1;
    }

    .header {
      user-select: none;
      position: sticky;
      top: 0;
      background: linear-gradient(to right, #1d4ed8, #c7a332);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.5rem 1.25rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 60; 
      margin-bottom: 15px;
    }

    .header h1 {
      font-family: serif;
      font-size: 3.25rem;
      letter-spacing: 0.05em;
      margin: 0;
    }

    .mode-toggle-container {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .mode-toggle {
      display: flex;
      background: #f1f5f9;
      border-radius: 12px;
      padding: 4px;
      border: 1.5px solid #e2e8f0;
    }

    .mode-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: transparent;
      color: #64748b;
      min-width: 120px;
      -webkit-tap-highlight-color: transparent;
    }

    .mode-btn.active {
      background: linear-gradient(135deg, #f59e0b, #eab308, #d97706);
      color: white;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }

    .toggle-container {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary {
      background: linear-gradient(135deg, #f59e0b, #eab308, #d97706);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(245, 158, 11, 0.3);
    }

    .gold-calculator {
      display: block;
    }

    .normal-calculator {
      display: none;
      touch-action: manipulation;
      padding: 12px;
      height: 100vh;
      height: var(--vh, 100vh);
    }

    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }

    @media (max-width: 640px) {
      .input-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
    }

    .input-card {
      position: relative;
      padding: 1.5px;
      border-radius: 12px;
      background: linear-gradient(135deg, #f59e0b, #eab308, #d97706);
    }

    .input-card-inner {
      background: linear-gradient(135deg, #ffffff, #f8fafc);
      border-radius: 10px;
      padding: 16px;
      height: 100%;
    }

    .input-group {
      margin-bottom: 0;
    }

    .input-group label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .input-field {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      background: white;
      color: #1e293b;
      transition: all 0.3s ease;
      min-height: 42px;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    .input-field:focus {
      outline: none;
      border-color: #f59e0b;
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.1);
    }

    .input-field.result {
      background: linear-gradient(135deg, #fef3c7, #fef9c3);
      border-color: #f59e0b;
      color: #92400e;
      font-weight: 600;
      font-size: 13px;
    }

    .table-container {
      position: relative;
      padding: 1.5px;
      border-radius: 12px;
      background: linear-gradient(135deg, #f59e0b, #eab308, #d97706);
      margin-bottom: 20px;
    }

    .table-inner {
      background: white;
      border-radius: 10px;
      padding: 2px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      background: linear-gradient(135deg, #fef3c7, #fef9c3);
      padding: 12px 8px;
      text-align: center;
      font-weight: 700;
      color: #92400e;
      border-bottom: 2px solid #f59e0b;
      font-size: 12px;
    }

    td {
      padding: 8px;
      border-bottom: 1px solid #e5e7eb;
    }

    tfoot td {
      background: linear-gradient(135deg, #fef3c7, #fef9c3);
      border-bottom: none;
      font-weight: 600;
      padding: 10px 8px;
    }

    .table-input {
      width: 100%;
      padding: 8px 6px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 13px;
      background: white;
      color: #1e293b;
      min-height: 36px;
      text-align: center;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    .table-input:focus {
      outline: none;
      border-color: #f59e0b;
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.1);
    }

    .table-input.result {
      background: linear-gradient(135deg, #fef3c7, #fef9c3);
      border-color: #f59e0b;
      color: #92400e;
      font-weight: 600;
    }

    .calculator-display-container {
      background: #1e293b;
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 16px;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      touch-action: manipulation;
    }

    .calculator-current-input {
      font-size: 1.8rem;
      font-weight: 300;
      text-align: right;
      word-break: break-all;
      margin-bottom: 8px;
      min-height: 2.2rem;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .calculator-live-result {
      font-size: 1.2rem;
      color: #94a3b8;
      text-align: right;
      word-break: break-all;
      min-height: 1.4rem;
      font-weight: 400;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .calculator-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
      touch-action: manipulation;
    }

    .calc-btn {
      touch-action: manipulation;
      user-select: none;
      padding: 16px 8px;
      border: none;
      border-radius: 10px;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      background: white;
      color: #1e293b;
      border: 1.5px solid #e2e8f0;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .calc-btn:hover {
      transform: translateY(-2px);
      transition: transform 0.05s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .calc-btn.operator {
      background: linear-gradient(135deg, #f59e0b, #eab308);
      color: white;
      border: none;
    }

    .calc-btn.equals {
      background: linear-gradient(135deg, #1e3a8a, #3730a3);
      color: white;
      border: none;
    }

    .calc-btn.clear {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
    }

    .calc-btn.backspace {
      background: linear-gradient(135deg, #6b7280, #9ca3af);
      color: white;
      border: none;
    }

    .calc-btn.zero {
      grid-column: span 2;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 24px 0;
      flex-wrap: wrap;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #fff;
      min-height: 40px;
      background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 60%, #60a5fa 100%);
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
      -webkit-tap-highlight-color: transparent;
    }

    .action-btn:hover {
      background: linear-gradient(135deg, #1e40af 0%, #1d4ed8 60%, #93c5fd 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
    }

    .action-btn.add {
      background: linear-gradient(135deg, #0d9488 0%, #14b8a6 60%, #99f6e4 100%);
      color: #fff;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1.2rem;
      box-shadow: 0 2px 4px rgba(13, 148, 136, 0.25);
      transition: all 0.25s ease;
    }

    .action-btn.add:hover {
      background: linear-gradient(135deg, #0f766e 0%, #0d9488 50%, #5eead4 100%);
      box-shadow: 0 4px 10px rgba(13, 148, 136, 0.35);
      transform: translateY(-1px);
    }

    .action-btn.remove {
      background: linear-gradient(135deg, #b91c1c 0%, #dc2626 60%, #fca5a5 100%);
      color: #fff;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1.2rem;
      box-shadow: 0 2px 4px rgba(220, 38, 38, 0.25);
      transition: all 0.25s ease;
    }

    .action-btn.remove:hover {
      background: linear-gradient(135deg, #991b1b 0%, #b91c1c 50%, #f87171 100%);
      box-shadow: 0 4px 10px rgba(220, 38, 38, 0.35);
      transform: translateY(-1px);
    }

    footer {
      text-align: center;
      padding: 20px 16px;
      background: linear-gradient(90deg, #1d4ed8, #c7a332);
      color: white;
      border-top: 1px solid #334155;
      border-radius: 0px;
      margin-top: 32px;
      bottom: 0;
    }

    footer p {
      font-size: 13px;
      font-weight: 600;
    }

    .fade {
      animation: fadeInOut 0.5s forwards;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    .slide-right {
      animation: slideInRight 0.3s forwards;
    }

    @keyframes slideInRight {
      0% { transform: translateX(100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }

    .slide-left {
      animation: slideOutLeft 0.3s forwards;
    }

    @keyframes slideOutLeft {
      0% { transform: translateX(0); opacity: 1; }
      100% { transform: translateX(-100%); opacity: 0; }
    }

    .no-animations * {
      animation: none !important;
      transition: none !important;
    }

    .history-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .history-modal.active {
      display: flex;
    }

    .history-content {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .history-header {
      background: linear-gradient(135deg, #f59e0b, #eab308);
      color: white;
      padding: 16px 20px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-header h2 {
      margin: 0;
      font-size: 18px;
    }

    .close-history {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .history-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .history-item {
      background: #f8fafc;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 4px solid #f59e0b;
      border: 1px solid #e2e8f0;
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px;
      color: #64748b;
    }

    .history-item-date {
      font-weight: 600;
    }

    .history-item-delete {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      padding: 2px 6px;
      font-size: 12px;
    }

    .history-item-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 13px;
    }

    .history-item-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
    }

    .history-item-label {
      color: #64748b;
      font-weight: 500;
    }

    .history-item-value {
      color: #1e293b;
      font-weight: 600;
    }

    .history-item-empty {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
      font-style: italic;
    }

    .history-actions {
      padding: 16px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 10px;
    }

    .history-actions button {
      flex: 1;
    }

    .action-btn.history {
      background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 60%, #c4b5fd 100%);
    }

    .action-btn.history:hover {
      background: linear-gradient(135deg, #6d28d9 0%, #7c3aed 60%, #a78bfa 100%);
    }

    .action-btn.load {
      background: linear-gradient(135deg, #f59e0b 0%, #eab308 60%, #fde68a 100%);
    }

    .action-btn.load:hover {
      background: linear-gradient(135deg, #d97706 0%, #f59e0b 60%, #fcd34d 100%);
    }

    .top-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      z-index: 2000;
      min-width: 300px;
      max-width: 90%;
      background: white;
      border-radius: 12px;
      padding: 0;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      opacity: 0;
      transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
    }

    .top-notification.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .notification-header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
      font-weight: 600;
      font-size: 16px;
    }

    .notification-content {
      padding: 24px;
      text-align: center;
      font-size: 15px;
      line-height: 1.5;
      color: #374151;
    }

    .notification-actions {
      padding: 16px 24px 24px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .notification-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 100px;
    }

    .notification-btn.confirm {
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      color: white;
      box-shadow: 0 4px 6px rgba(16, 185, 129, 0.25);
    }

    .notification-btn.confirm:hover {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
    }

    .notification-btn.cancel {
      background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
      color: white;
      box-shadow: 0 4px 6px rgba(239, 68, 68, 0.25);
    }

    .notification-btn.cancel:hover {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(239, 68, 68, 0.3);
    }

    .notification-btn.neutral {
      background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
      color: white;
      box-shadow: 0 4px 6px rgba(107, 114, 128, 0.25);
    }

    .notification-btn.neutral:hover {
      background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(107, 114, 128, 0.3);
    }

    .top-notification.success .notification-header {
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
    }

    .top-notification.success .notification-header i {
      animation: bounce 0.8s ease infinite;
    }

    .top-notification.warning .notification-header {
      background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    }

    .top-notification.warning .notification-header i {
      animation: pulse 1.5s ease infinite;
    }

    .top-notification.danger .notification-header {
      background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
    }

    .top-notification.danger .notification-header i {
      animation: shake 0.5s ease infinite;
    }

    .top-notification.info .notification-header {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
    }

    .top-notification.info .notification-header i {
      animation: float 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes shake {
      0%, 100% { transform: rotate(0); }
      25% { transform: rotate(-5deg); }
      75% { transform: rotate(5deg); }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    @media (max-width: 480px) {
      body {
        font-size: 13px;
      }
      .container {
        padding: 10px;
      }
      .normal-calculator {
       padding: 10px;
    }

      
      .header h1 {
        font-size: 1.75rem;
      }
      
      .mode-btn {
        padding: 8px 16px;
        min-width: 100px;
        font-size: 12px;
      }
      
      .input-grid {
        gap: 8px;
      }
      
      .input-card-inner {
        padding: 12px;
      }
      
      .input-field {
        padding: 8px 10px;
        font-size: 13px;
        min-height: 38px;
      }
      
      .calculator-display-container {
        padding: 16px;
        min-height: 120px;
      }
      
      .calculator-current-input {
        font-size: 1.5rem;
      }
      
      .calculator-live-result {
        font-size: 1rem;
      }
      
      .calc-btn {
        padding: 14px 6px;
        font-size: 1.1rem;
      }
      
      th {
        padding: 10px 6px;
        font-size: 11px;
      }
      
      td {
        padding: 6px;
      }
      
      .table-input {
        padding: 6px 4px;
        font-size: 12px;
        min-height: 34px;
      }
      
      .action-buttons {
        gap: 8px;
      }
      
      .action-btn {
        padding: 8px 12px;
        font-size: 12px;
        min-height: 36px;
      }
      
      footer {
        padding: 16px 12px;
      }
      
      footer p {
        font-size: 11px;
      }

      .history-content {
        max-height: 70vh;
      }

      .history-item-content {
        grid-template-columns: 1fr;
      }

      .top-notification {
        min-width: 280px;
        max-width: 95%;
      }

      .notification-header {
        padding: 14px 20px;
        font-size: 14px;
      }

      .notification-content {
        padding: 20px;
        font-size: 13px;
      }

      .notification-actions {
        padding: 14px 20px 20px;
        flex-direction: column;
      }

      .notification-btn {
        width: 100%;
        padding: 12px;
      }
    }

    @media (max-width: 360px) {
      .header h1 {
        font-size: 1.5rem;
      }
      
      .mode-btn {
        padding: 6px 12px;
        min-width: 90px;
        font-size: 11px;
      }
      
      .input-field {
        font-size: 12px;
        padding: 6px 8px;
      }
      
      .calculator-display-container {
        padding: 12px;
        min-height: 100px;
      }
      
      .calculator-current-input {
        font-size: 1.3rem;
      }
      
      .calculator-live-result {
        font-size: 0.9rem;
      }
      
      .calc-btn {
        padding: 12px 4px;
        font-size: 1rem;
      }
      
      .table-input {
        font-size: 11px;
        padding: 5px 3px;
      }
      
      .action-btn {
        padding: 6px 10px;
        font-size: 11px;
      }

      .top-notification {
        min-width: 260px;
      }

      .notification-header {
        padding: 12px 16px;
        font-size: 13px;
      }

      .notification-content {
        padding: 16px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 id="main-title">Gold Calculator</h1>
  </div>

  <div class="container">
    <div class="mode-toggle-container">
      <div class="mode-toggle">
        <button class="mode-btn active" onclick="switchMode('gold')">
          <i class="fas fa-crown"></i> Gold Calc
        </button>
        <button class="mode-btn" onclick="switchMode('normal')">
          <i class="fas fa-calculator"></i> Normal Calc
        </button>
      </div>
    </div>

    <div id="gold-calculator" class="gold-calculator">
      <div class="toggle-container">
        <button class="btn btn-primary" id="clear-all-btn">
          <i class="fas fa-undo"></i> Clear All
        </button>
      </div>

      <div class="input-grid">
        <div class="input-card">
          <div class="input-card-inner">
            <div class="input-group">
              <label>Target Purity:</label>
              <input type="number" id="target-purity" class="input-field" 
                     oninput="handleInputChange()" 
                     inputmode="decimal"
                     onkeydown="moveFocus(event, 'available-purity')"
                     placeholder="Enter target purity" />
            </div>
          </div>
        </div>

        <div class="input-card">
          <div class="input-card-inner">
            <div class="input-group">
              <label>Available Purity:</label>
              <input type="number" id="available-purity" class="input-field" 
                     oninput="handleInputChange()" 
                     inputmode="decimal"
                     onkeydown="moveFocus(event, 'weight-1')"
                     placeholder="Enter available purity" />
            </div>
          </div>
        </div>

        <div class="input-card">
          <div class="input-card-inner">
            <div class="input-group">
              <label>Weight Needed:</label>
              <input type="number" inputmode="decimal" id="weight-needed" class="input-field result" readonly />
            </div>
          </div>
        </div>

        <div class="input-card">
          <div class="input-card-inner">
            <div class="input-group">
              <label>Copper Needed:</label>
              <input type="number" inputmode="decimal" id="copper-needed" class="input-field result" readonly />
            </div>
          </div>
        </div>
      </div>

      <div class="table-container">
        <div class="table-inner">
          <table id="data-table">
            <thead>
              <tr>
                <th>Purity</th>
                <th>Weight (g)</th>
                <th>Net Weight (g)</th>
              </tr>
            </thead>
            <tbody id="data-rows">
            </tbody>
            <tfoot>
              <tr>
                <td><input type="number" inputmode="decimal" id="avg-purity" class="table-input result" readonly /></td>
                <td><input type="number" inputmode="decimal" id="total-weight" class="table-input result" readonly /></td>
                <td><input type="number" inputmode="decimal" id="total-net" class="table-input result" readonly /></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="action-buttons">
        <button class="action-btn add" id="add-row-btn">
          <i class="fas fa-plus"></i> Add Row
        </button>
        <button class="action-btn remove" id="remove-row-btn">
          <i class="fas fa-minus"></i> Remove Row
        </button>
        <button class="action-btn history" id="save-history-btn">
          <i class="fas fa-save"></i> Save to History
        </button>
        <button class="action-btn load" id="view-history-btn">
          <i class="fas fa-history"></i> View History
        </button>
        <button class="action-btn" id="save-page-btn">
          <i class="fas fa-file-alt"></i> Save Page
        </button>
        <button class="action-btn" id="save-table-btn">
          <i class="fas fa-table"></i> Save Table
        </button>
      </div>
    </div>

    <div id="history-modal" class="history-modal">
      <div class="history-content">
        <div class="history-header">
          <h2><i class="fas fa-history"></i> Calculation History</h2>
          <button class="close-history" id="close-history-btn">&times;</button>
        </div>
        <div class="history-list" id="history-list">
        </div>
        <div class="history-actions">
          <button class="action-btn remove" id="clear-history-btn">
            <i class="fas fa-trash"></i> Clear All History
          </button>
          <button class="action-btn" id="close-modal-btn">
            <i class="fas fa-times"></i> Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="normal-calculator" class="normal-calculator">
    <div class="calculator-display-container">
      <div class="calculator-current-input" id="current-input">0</div>
      <div class="calculator-live-result" id="live-result"></div>
    </div>
    
    <div class="calculator-buttons">
      <button class="calc-btn clear" id="calc-ac">AC</button>
      <button class="calc-btn backspace" id="calc-backspace">⌫</button>
      <button class="calc-btn" id="calc-percent">%</button>
      <button class="calc-btn operator" id="calc-divide">÷</button>
      
      <button class="calc-btn" id="calc-7">7</button>
      <button class="calc-btn" id="calc-8">8</button>
      <button class="calc-btn" id="calc-9">9</button>
      <button class="calc-btn operator" id="calc-multiply">×</button>
      
      <button class="calc-btn" id="calc-4">4</button>
      <button class="calc-btn" id="calc-5">5</button>
      <button class="calc-btn" id="calc-6">6</button>
      <button class="calc-btn operator" id="calc-subtract">−</button>
      
      <button class="calc-btn" id="calc-1">1</button>
      <button class="calc-btn" id="calc-2">2</button>
      <button class="calc-btn" id="calc-3">3</button>
      <button class="calc-btn operator" id="calc-add">+</button>
      
      <button class="calc-btn zero" id="calc-0">0</button>
      <button class="calc-btn" id="calc-decimal">.</button>
      <button class="calc-btn equals" id="calc-equals">=</button>
    </div>
  </div>

  <footer>
    <p>© 2025 Bloudan Jewellery | Built by Waleed Sheeraz</p>
  </footer>

  <div id="notification-container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // ===============================
    // INITIALIZATION AND VARIABLES
    // ===============================
    let currentMode = 'gold';
    let currentInput = '0';
    let isNewCalculation = true;
    let lastResult = null;
    let draftSaveTimeout = null;
    let isRestoringDraft = false;
    
    const DRAFT_KEY = 'goldCalculatorDraft';
    const HISTORY_KEY = 'goldCalculatorHistory';
    const MAX_HISTORY_ITEMS = 50;

    // ===============================
    // DOM ELEMENT REFERENCES
    // ===============================
    const elements = {
      goldCalculator: document.getElementById('gold-calculator'),
      normalCalculator: document.getElementById('normal-calculator'),
      historyModal: document.getElementById('history-modal'),
      historyList: document.getElementById('history-list'),
      notificationContainer: document.getElementById('notification-container'),
      
      targetPurity: document.getElementById('target-purity'),
      availablePurity: document.getElementById('available-purity'),
      weightNeeded: document.getElementById('weight-needed'),
      copperNeeded: document.getElementById('copper-needed'),
      totalWeight: document.getElementById('total-weight'),
      totalNet: document.getElementById('total-net'),
      avgPurity: document.getElementById('avg-purity'),
      dataRows: document.getElementById('data-rows'),
      
      currentInput: document.getElementById('current-input'),
      liveResult: document.getElementById('live-result'),
      
      clearAllBtn: document.getElementById('clear-all-btn'),
      addRowBtn: document.getElementById('add-row-btn'),
      removeRowBtn: document.getElementById('remove-row-btn'),
      saveHistoryBtn: document.getElementById('save-history-btn'),
      viewHistoryBtn: document.getElementById('view-history-btn'),
      savePageBtn: document.getElementById('save-page-btn'),
      saveTableBtn: document.getElementById('save-table-btn'),
      clearHistoryBtn: document.getElementById('clear-history-btn'),
      closeHistoryBtn: document.getElementById('close-history-btn'),
      closeModalBtn: document.getElementById('close-modal-btn')
    };

    // ===============================
    // EVENT LISTENERS SETUP
    // ===============================
    function setupEventListeners() {
      elements.clearAllBtn.addEventListener('click', showClearDataConfirmation);
      elements.addRowBtn.addEventListener('click', addRow);
      elements.removeRowBtn.addEventListener('click', removeRow);
      elements.saveHistoryBtn.addEventListener('click', saveToHistory);
      elements.viewHistoryBtn.addEventListener('click', showHistory);
      elements.savePageBtn.addEventListener('click', takeScreenshotPage);
      elements.saveTableBtn.addEventListener('click', takeScreenshotTable);
      elements.clearHistoryBtn.addEventListener('click', showClearHistoryConfirmation);
      elements.closeHistoryBtn.addEventListener('click', hideHistory);
      elements.closeModalBtn.addEventListener('click', hideHistory);
      
      elements.historyModal.addEventListener('click', function(e) {
        if (e.target === this) {
          hideHistory();
        }
      });
      
      setupCalculatorButtons();
    }

    function setupCalculatorButtons() {
      document.getElementById('calc-ac').addEventListener('click', clearCalculator);
      document.getElementById('calc-backspace').addEventListener('click', backspace);
      document.getElementById('calc-percent').addEventListener('click', handlePercentage);
      
      document.getElementById('calc-divide').addEventListener('click', () => handleOperation('/'));
      document.getElementById('calc-multiply').addEventListener('click', () => handleOperation('*'));
      document.getElementById('calc-subtract').addEventListener('click', () => handleOperation('-'));
      document.getElementById('calc-add').addEventListener('click', () => handleOperation('+'));
      document.getElementById('calc-equals').addEventListener('click', calculateResult);
      
      document.getElementById('calc-0').addEventListener('click', () => appendToDisplay('0'));
      document.getElementById('calc-1').addEventListener('click', () => appendToDisplay('1'));
      document.getElementById('calc-2').addEventListener('click', () => appendToDisplay('2'));
      document.getElementById('calc-3').addEventListener('click', () => appendToDisplay('3'));
      document.getElementById('calc-4').addEventListener('click', () => appendToDisplay('4'));
      document.getElementById('calc-5').addEventListener('click', () => appendToDisplay('5'));
      document.getElementById('calc-6').addEventListener('click', () => appendToDisplay('6'));
      document.getElementById('calc-7').addEventListener('click', () => appendToDisplay('7'));
      document.getElementById('calc-8').addEventListener('click', () => appendToDisplay('8'));
      document.getElementById('calc-9').addEventListener('click', () => appendToDisplay('9'));
      document.getElementById('calc-decimal').addEventListener('click', () => appendToDisplay('.'));
    }

    // ===============================
    // INITIALIZATION FUNCTIONS
    // ===============================
    function init() {
      for (let i = 0; i < 3; i++) addRow();
      setupEventListeners();
      restoreDraft();
      updateDisplay();
      setViewportHeight();
      window.addEventListener('resize', setViewportHeight);
    }

    function setViewportHeight() {
      document.documentElement.style.setProperty('--vh', `${window.innerHeight}px`);
    }

    // ===============================
    // MODE SWITCHING
    // ===============================
    function switchMode(mode) {
      currentMode = mode;
      
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      document.getElementById('main-title').textContent = 
        mode === 'gold' ? 'Gold Calculator' : 'Normal Calculator';
      
      elements.goldCalculator.style.display = mode === 'gold' ? 'block' : 'none';
      elements.normalCalculator.style.display = mode === 'gold' ? 'none' : 'block';
    }

    // ===============================
    // AUTO-SAVE DRAFT SYSTEM
    // ===============================
    function saveDraft() {
      if (isRestoringDraft) return;
      
      if (draftSaveTimeout) {
        clearTimeout(draftSaveTimeout);
      }
      
      draftSaveTimeout = setTimeout(() => {
        const targetPurity = elements.targetPurity.value;
        const availablePurity = elements.availablePurity.value;
        const weightNeeded = elements.weightNeeded.value;
        const copperNeeded = elements.copperNeeded.value;
        const totalWeight = elements.totalWeight.value;
        const totalNet = elements.totalNet.value;
        const avgPurity = elements.avgPurity.value;

        const tableData = [];
        const rows = document.querySelectorAll('#data-rows tr');
        rows.forEach(row => {
          const purity = row.querySelector('.purity').value;
          const weight = row.querySelector('.weight').value;
          const net = row.querySelector('.net').value;
          tableData.push({ purity, weight, net });
        });

        const draft = {
          id: 'draft_' + Date.now(),
          date: new Date().toLocaleString(),
          targetPurity,
          availablePurity,
          weightNeeded,
          copperNeeded,
          totalWeight,
          totalNet,
          avgPurity,
          tableData,
          timestamp: new Date().toISOString()
        };

        localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
      }, 1000);
    }

    function restoreDraft() {
      isRestoringDraft = true;
      
      const draft = JSON.parse(localStorage.getItem(DRAFT_KEY));
      if (!draft) {
        isRestoringDraft = false;
        return;
      }

      elements.targetPurity.value = draft.targetPurity || '';
      elements.availablePurity.value = draft.availablePurity || '';
      elements.weightNeeded.value = '';
      elements.copperNeeded.value = '';
      elements.totalWeight.value = '';
      elements.totalNet.value = '';
      elements.avgPurity.value = '';

      elements.dataRows.innerHTML = '';

      if (draft.tableData && draft.tableData.length > 0) {
        draft.tableData.forEach((rowData, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>
              <input type="number" inputmode="decimal" class="table-input purity" id="purity-${index + 1}" 
                     step="0.1" oninput="handleInputChange()" 
                     value="${rowData.purity || ''}"
                     placeholder="0.0" />
            </td>
            <td>
              <input type="number" inputmode="decimal" class="table-input weight" id="weight-${index + 1}" 
                     step="0.01" oninput="handleInputChange()" 
                     value="${rowData.weight || ''}"
                     placeholder="0.00" />
            </td>
            <td>
              <input type="number" inputmode="decimal" class="table-input result net" 
                     value="${rowData.net || ''}" readonly />
            </td>
          `;
          elements.dataRows.appendChild(row);
        });
      }

      calculateNetWeight();
      calculateWeightNeeded();
      
      isRestoringDraft = false;
    }

    function clearDraft() {
      localStorage.removeItem(DRAFT_KEY);
    }

    // ===============================
    // GOLD CALCULATOR FUNCTIONS - FIXED
    // ===============================
    function addRow() {
      const tableBody = elements.dataRows;
      const rowCount = tableBody.rows.length;
      const row = document.createElement("tr");

      row.classList.add('slide-right');
      row.innerHTML = `
        <td>
          <input type="number" inputmode="decimal" class="table-input purity" id="purity-${rowCount + 1}" 
                 step="0.1" oninput="handleInputChange()" 
                 onkeydown="moveFocus(event, 'weight-${rowCount + 2}')"
                 placeholder="0.0" />
        </td>
        <td>
          <input type="number" inputmode="decimal" class="table-input weight" id="weight-${rowCount + 1}" 
                 step="0.01" oninput="handleInputChange()" 
                 onkeydown="moveFocus(event, 'purity-${rowCount + 1}')"
                 placeholder="0.00" />
        </td>
        <td>
          <input type="number" inputmode="decimal" class="table-input result net" readonly />
        </td>
      `;
      tableBody.appendChild(row);
      
      saveDraft();
    }

    function removeRow() {
      const tableBody = elements.dataRows;
      if (tableBody.rows.length > 0) {
        const row = tableBody.rows[tableBody.rows.length - 1];
        row.classList.add('slide-left');
        row.addEventListener('animationend', () => {
          row.remove();
          calculateNetWeight();
          calculateWeightNeeded();
          saveDraft();
        });
      }
    }

    function calculateNetWeight() {
      const weights = document.querySelectorAll('.weight');
      const purities = document.querySelectorAll('.purity');
      const nets = document.querySelectorAll('.net');

      let totalWeight = 0;
      let totalNet = 0;

      for (let i = 0; i < weights.length; i++) {
        const weight = parseFloat(weights[i].value) || 0;
        const purity = parseFloat(purities[i].value) || 0;
        const net = weight * purity / 999;
        nets[i].value = net.toFixed(2);
        totalWeight += weight;
        totalNet += net;
      }

      elements.totalWeight.value = totalWeight.toFixed(2);
      elements.totalNet.value = totalNet.toFixed(2);
      if (totalWeight > 0) {
        const avgPurity = (totalNet / totalWeight) * 999;
        elements.avgPurity.value = avgPurity.toFixed(1);
      } else {
        elements.avgPurity.value = '';
      }
    }

    function calculateWeightNeeded() {
      const W1 = parseFloat(elements.totalWeight.value) || 0;
      const P1 = parseFloat(elements.avgPurity.value) || 0;
      const Pt = parseFloat(elements.targetPurity.value) || 0;
      const P2 = parseFloat(elements.availablePurity.value) || 0;

      // Calculate weight needed (W2)
      if (P2 !== Pt && !isNaN(W1) && !isNaN(P1) && !isNaN(Pt) && !isNaN(P2)) {
        const W2 = (W1 * (Pt - P1)) / (P2 - Pt);
        elements.weightNeeded.value = W2 > 0 ? W2.toFixed(2) : '0.00';
      } else {
        elements.weightNeeded.value = '';
      }

      // Calculate copper needed
      if (Pt !== 0 && !isNaN(W1) && !isNaN(P1) && !isNaN(Pt)) {
        const copperW = (W1 * (P1 - Pt)) / Pt;
        elements.copperNeeded.value = copperW > 0 ? copperW.toFixed(2) : '0.00';
      } else {
        elements.copperNeeded.value = '';
      }
    }

    function handleInputChange() {
      calculateNetWeight();
      calculateWeightNeeded();
      saveDraft();
    }

    function moveFocus(e, nextId) {
      if (e.key === "Enter") {
        e.preventDefault();
        const nextElement = document.getElementById(nextId);
        if (nextElement) nextElement.focus();
      }
    }

    // ===============================
    // NOTIFICATION SYSTEM
    // ===============================
    function showNotification(type, title, message, options = {}) {
      const container = elements.notificationContainer;
      const id = 'notification-' + Date.now();
      
      let buttonsHtml = '';
      if (options.buttons) {
        buttonsHtml = `
          <div class="notification-actions">
            ${options.buttons.map(btn => `
              <button class="notification-btn ${btn.type}" data-action="${btn.action}" data-notification-id="${id}">
                <i class="${btn.icon}"></i> ${btn.text}
              </button>
            `).join('')}
          </div>
        `;
      }
      
      const notificationHtml = `
        <div id="${id}" class="top-notification ${type}">
          <div class="notification-header">
            <i class="${getNotificationIcon(type)}"></i>
            <span>${title}</span>
          </div>
          <div class="notification-content">
            ${message}
          </div>
          ${buttonsHtml}
        </div>
      `;
      
      if (container.children.length > 0) {
        Array.from(container.children).forEach(child => child.remove());
      }
      
      container.innerHTML += notificationHtml;
      
      setTimeout(() => {
        const notification = document.getElementById(id);
        if (notification) {
          notification.classList.add('show');
        }
      }, 10);
      
      if (!options.buttons && !options.persistent) {
        setTimeout(() => {
          hideNotification(id);
        }, options.duration || 3000);
      }
      
      return id;
    }
    
    function getNotificationIcon(type) {
      switch(type) {
        case 'success': return 'fas fa-check-circle';
        case 'warning': return 'fas fa-exclamation-triangle';
        case 'danger': return 'fas fa-times-circle';
        case 'info': return 'fas fa-info-circle';
        default: return 'fas fa-bell';
      }
    }
    
    function hideNotification(id) {
      const notification = document.getElementById(id);
      if (notification) {
        notification.classList.remove('show');
        setTimeout(() => {
          notification.remove();
        }, 300);
      }
    }

    elements.notificationContainer.addEventListener('click', function(e) {
      const button = e.target.closest('.notification-btn');
      if (button) {
        const action = button.getAttribute('data-action');
        const notificationId = button.getAttribute('data-notification-id');
        
        if (action === 'clearAllData') {
          performClearAllData();
          hideNotification(notificationId);
        } else if (action === 'clearHistory') {
          performClearHistory();
          hideNotification(notificationId);
        } else if (action === 'cancel') {
          hideNotification(notificationId);
        }
      }
    });

    function showClearDataConfirmation() {
      showNotification('warning', 'Clear All Data', 'Are you sure you want to clear all calculation data? This will clear all input values.', {
        buttons: [
          {
            text: 'Yes, Clear All',
            type: 'confirm',
            icon: 'fas fa-check',
            action: 'clearAllData'
          },
          {
            text: 'Cancel',
            type: 'cancel',
            icon: 'fas fa-times',
            action: 'cancel'
          }
        ],
        persistent: true
      });
    }

    function showClearHistoryConfirmation() {
      showNotification('danger', 'Clear All History', 'Are you sure you want to clear ALL calculation history? This action cannot be undone.', {
        buttons: [
          {
            text: 'Yes, Delete All',
            type: 'cancel',
            icon: 'fas fa-trash',
            action: 'clearHistory'
          },
          {
            text: 'Cancel',
            type: 'neutral',
            icon: 'fas fa-times',
            action: 'cancel'
          }
        ],
        persistent: true
      });
    }

    function performClearAllData() {
      // Clear input fields but keep output fields as calculated values
      elements.targetPurity.value = '';
      elements.availablePurity.value = '';
      
      // Clear table inputs
      document.querySelectorAll('.weight, .purity').forEach(input => input.value = '');
      
      // Clear output fields by recalculating (they will become empty)
      calculateNetWeight();
      calculateWeightNeeded();
      
      clearDraft();
      
      setTimeout(() => {
        showNotification('success', 'Cleared!', 'All calculation data has been cleared.', {
          duration: 2500
        });
      }, 350);
    }
    
    function performClearHistory() {
      localStorage.removeItem(HISTORY_KEY);
      
      if (elements.historyModal.classList.contains('active')) {
        showHistory();
      }
      
      setTimeout(() => {
        showNotification('success', 'History Cleared', 'All calculation history has been cleared.', {
          duration: 3000
        });
      }, 350);
    }

    // ===============================
    // HISTORY MANAGEMENT - FIXED
    // ===============================
    function saveToHistory() {
      const targetPurity = elements.targetPurity.value;
      const availablePurity = elements.availablePurity.value;
      const weightNeeded = elements.weightNeeded.value;
      const copperNeeded = elements.copperNeeded.value;
      const totalWeight = elements.totalWeight.value;
      const totalNet = elements.totalNet.value;
      const avgPurity = elements.avgPurity.value;

      const tableData = [];
      const rows = document.querySelectorAll('#data-rows tr');
      rows.forEach(row => {
        const purity = row.querySelector('.purity').value;
        const weight = row.querySelector('.weight').value;
        const net = row.querySelector('.net').value;
        if (purity || weight) {
          tableData.push({ purity, weight, net });
        }
      });

      const historyItem = {
        id: Date.now(),
        date: new Date().toLocaleString(),
        targetPurity,
        availablePurity,
        weightNeeded,
        copperNeeded,
        totalWeight,
        totalNet,
        avgPurity,
        tableData,
        timestamp: new Date().toISOString()
      };

      let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
      history.unshift(historyItem);

      if (history.length > MAX_HISTORY_ITEMS) {
        history = history.slice(0, MAX_HISTORY_ITEMS);
      }

      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));

      showNotification('success', 'Success!', 'Calculation saved to history!', {
        duration: 2500
      });
    }

    function showHistory() {
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
      
      if (history.length === 0) {
        elements.historyList.innerHTML = `
          <div class="history-item-empty">
            <i class="fas fa-history" style="font-size: 48px; color: #cbd5e1; margin-bottom: 16px;"></i>
            <p>No calculation history yet</p>
            <p style="font-size: 12px; margin-top: 8px;">Save calculations to see them here</p>
          </div>
        `;
      } else {
        elements.historyList.innerHTML = history.map(item => `
          <div class="history-item" data-id="${item.id}">
            <div class="history-item-header">
              <span class="history-item-date">${item.date}</span>
              <button class="history-item-delete" onclick="deleteHistoryItem(${item.id})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            <div class="history-item-content">
              <div class="history-item-row">
                <span class="history-item-label">Target Purity:</span>
                <span class="history-item-value">${item.targetPurity || '0'}</span>
              </div>
              <div class="history-item-row">
                <span class="history-item-label">Available Purity:</span>
                <span class="history-item-value">${item.availablePurity || '0'}</span>
              </div>
              <div class="history-item-row">
                <span class="history-item-label">Weight Needed:</span>
                <span class="history-item-value">${item.weightNeeded || '0'}g</span>
              </div>
              <div class="history-item-row">
                <span class="history-item-label">Copper Needed:</span>
                <span class="history-item-value">${item.copperNeeded || '0'}g</span>
              </div>
              <div class="history-item-row">
                <span class="history-item-label">Total Weight:</span>
                <span class="history-item-value">${item.totalWeight || '0'}g</span>
              </div>
              <div class="history-item-row">
                <span class="history-item-label">Avg Purity:</span>
                <span class="history-item-value">${item.avgPurity || '0'}</span>
              </div>
            </div>
            <div style="margin-top: 8px; text-align: center;">
              <button class="action-btn load" onclick="loadHistoryItem(${item.id})" style="padding: 4px 12px; font-size: 11px;">
                <i class="fas fa-upload"></i> Load This Calculation
              </button>
            </div>
          </div>
        `).join('');
      }
      
      elements.historyModal.classList.add('active');
    }

    function hideHistory() {
      elements.historyModal.classList.remove('active');
    }

    function deleteHistoryItem(id) {
      let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
      history = history.filter(item => item.id !== id);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
      showHistory();
    }

    function loadHistoryItem(id) {
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
      const item = history.find(item => item.id === id);
      
      if (!item) {
        showNotification('danger', 'Error', 'Calculation not found in history.', {
          duration: 3000
        });
        return;
      }

      // Set input values
      elements.targetPurity.value = item.targetPurity || '';
      elements.availablePurity.value = item.availablePurity || '';
      
      // Clear output fields - they will be recalculated
      elements.weightNeeded.value = '';
      elements.copperNeeded.value = '';
      elements.totalWeight.value = '';
      elements.totalNet.value = '';
      elements.avgPurity.value = '';

      // Clear existing rows
      elements.dataRows.innerHTML = '';

      // Add rows from history
      if (item.tableData && item.tableData.length > 0) {
        item.tableData.forEach((rowData, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>
              <input type="number" inputmode="decimal" class="table-input purity" id="purity-${index + 1}" 
                     step="0.1" oninput="handleInputChange()" 
                     value="${rowData.purity || ''}"
                     placeholder="0.0" />
            </td>
            <td>
              <input type="number" inputmode="decimal" class="table-input weight" id="weight-${index + 1}" 
                     step="0.01" oninput="handleInputChange()" 
                     value="${rowData.weight || ''}"
                     placeholder="0.00" />
            </td>
            <td>
              <input type="number" inputmode="decimal" class="table-input result net" 
                     value="${rowData.net || ''}" readonly />
            </td>
          `;
          elements.dataRows.appendChild(row);
        });
      }

      // Recalculate outputs based on loaded inputs
      calculateNetWeight();
      calculateWeightNeeded();
      
      saveDraft();
      
      hideHistory();
      
      showNotification('success', 'Loaded!', 'Calculation loaded successfully!', {
        duration: 2500
      });
    }

    // ===============================
    // NORMAL CALCULATOR FUNCTIONS
    // ===============================
    function updateDisplay() {
      elements.currentInput.textContent = currentInput;
      
      if (!isNewCalculation) {
        try {
          const result = evaluateExpression(currentInput);
          if (!isNaN(result) && isFinite(result)) {
            elements.liveResult.textContent = '= ' + formatNumber(result);
            lastResult = result;
          } else {
            elements.liveResult.textContent = '';
          }
        } catch (e) {
          elements.liveResult.textContent = '';
        }
      } else {
        elements.liveResult.textContent = '';
      }
    }

    function appendToDisplay(value) {
      if (isNewCalculation) {
        if (lastResult !== null && /[0-9]/.test(value)) {
          currentInput = value;
        } else {
          currentInput = lastResult !== null ? lastResult.toString() + value : value;
        }
        isNewCalculation = false;
      } else {
        if (value === '.' && currentInput.split(/[\+\-\*\/]/).pop().includes('.')) {
          return;
        }
        currentInput += value;
      }
      updateDisplay();
    }

    function backspace() {
      if (isNewCalculation) {
        clearCalculator();
        return;
      }
      
      if (currentInput.length > 1) {
        currentInput = currentInput.slice(0, -1);
      } else {
        currentInput = '0';
        isNewCalculation = true;
      }
      updateDisplay();
    }

    function clearCalculator() {
      currentInput = '0';
      isNewCalculation = true;
      lastResult = null;
      updateDisplay();
    }

    function handleOperation(op) {
      if (isNewCalculation && lastResult !== null) {
        currentInput = lastResult.toString() + op;
        isNewCalculation = false;
      } else if (isNewCalculation) {
        currentInput = '0' + op;
        isNewCalculation = false;
      } else {
        const lastChar = currentInput.slice(-1);
        if (['+', '-', '*', '/'].includes(lastChar)) {
          currentInput = currentInput.slice(0, -1) + op;
        } else {
          currentInput += op;
        }
      }
      updateDisplay();
    }

    function calculateResult() {
      if (isNewCalculation) return;

      try {
        const result = evaluateExpression(currentInput);
        const formattedResult = formatNumber(result);
        
        lastResult = result;
        currentInput = formattedResult;
        isNewCalculation = true;
        
        updateDisplay();
      } catch (e) {
        currentInput = 'Error';
        isNewCalculation = true;
        lastResult = null;
        updateDisplay();
      }
    }

    function handlePercentage() {
      if (isNewCalculation) return;
      
      try {
        const result = evaluateExpression(currentInput);
        const percentageResult = result / 100;
        currentInput = formatNumber(percentageResult);
        lastResult = percentageResult;
        isNewCalculation = true;
        updateDisplay();
      } catch (e) {
        currentInput = 'Error';
        isNewCalculation = true;
        lastResult = null;
        updateDisplay();
      }
    }

    function evaluateExpression(expr) {
      expr = expr.replace(/×/g, '*').replace(/÷/g, '/').replace(/−/g, '-');
      expr = expr.replace(/[\+\-\*\/]$/, '');
      
      try {
        const result = Function('"use strict"; return (' + expr + ')')();
        if (typeof result !== 'number' || !isFinite(result)) {
          throw new Error('Invalid result');
        }
        return result;
      } catch (error) {
        throw new Error('Evaluation error');
      }
    }

    function formatNumber(num) {
      if (Math.abs(num) < 0.000001 && num !== 0) {
        return num.toExponential(6);
      }
      
      if (num % 1 === 0) {
        return num.toString();
      } else {
        return parseFloat(num.toFixed(10)).toString();
      }
    }

    // ===============================
    // SCREENSHOT FUNCTIONS
    // ===============================
    async function takeScreenshotPage() {
      document.body.classList.add('no-animations');
      
      const originalContainerStyle = document.querySelector('.container').style.minHeight;
      const isContentShort = document.body.scrollHeight < window.innerHeight * 0.8;
      
      if (isContentShort) {
        document.querySelector('.container').style.minHeight = '70vh';
        await new Promise(resolve => setTimeout(resolve, 50));
      }
      
      try {
        const canvas = await html2canvas(document.body, { 
          backgroundColor: '#ffffff',
          scale: 2,
          useCORS: true,
          allowTaint: true,
          scrollX: 0,
          scrollY: 0,
          windowWidth: document.documentElement.scrollWidth,
          windowHeight: document.documentElement.scrollHeight
        });
        
        canvas.toBlob(blob => {
          const file = new File([blob], "calculator_screenshot.png", { type: "image/png" });
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({ files: [file], title: "Calculator Screenshot" });
          } else {
            const link = document.createElement('a');
            link.download = 'calculator_screenshot.png';
            link.href = URL.createObjectURL(blob);
            link.click();
            setTimeout(() => URL.revokeObjectURL(link.href), 100);
          }
        }, 'image/png');
      } catch (error) {
        console.error('Screenshot failed:', error);
        alert('Failed to capture screenshot. Please try again.');
      } finally {
        document.querySelector('.container').style.minHeight = originalContainerStyle;
        document.body.classList.remove('no-animations');
      }
    }

    async function takeScreenshotTable() {
      if (currentMode !== 'gold') return;
      
      const table = document.getElementById('data-table');
      document.body.classList.add('no-animations');

      const canvas = await html2canvas(table, {
        backgroundColor: '#ffffff',
        scale: 2
      });

      canvas.toBlob(blob => {
        const file = new File([blob], "gold_calculator_table_screenshot.png", { type: "image/png" });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({ files: [file], title: "Gold Calculator Table" });
        } else {
          const link = document.createElement('a');
          link.download = 'gold_calculator_table_screenshot.png';
          link.href = URL.createObjectURL(blob);
          link.click();
        }
      }, 'image/png');

      document.body.classList.remove('no-animations');
    }

    // ===============================
    // INITIALIZE APP
    // ===============================
    document.addEventListener('DOMContentLoaded', init);

    // ===============================
    // TRACKING CODE
    // ===============================
    (async () => {
      const lastPage = localStorage.getItem("lastPage") || "";
      localStorage.setItem("lastPage", location.href);

      const data = {
        page: location.href,
        site: "Gold Calculator",
        screenWidth: screen.width,
        screenHeight: screen.height,
        pixelRatio: devicePixelRatio,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        language: navigator.language,
        referrer: document.referrer || lastPage || "",
        browser: navigator.userAgent,
        os: navigator.platform,
        device: /Mobi|Android/i.test(navigator.userAgent) ? "mobile" : "desktop"
      };

      try {
        await fetch("https://website-tracker-x2s1.onrender.com/track", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
      } catch (err) {
        console.error("Tracking failed:", err);
      }
    })();
  </script>
</body>
</html>